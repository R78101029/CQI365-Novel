---
import BaseLayout from '../../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import config from '../../../../../novels.config.json';
import stats from '../../../data/novels-stats.json';

export async function getStaticPaths() {
  return config.novels.map(novel => ({
    params: { novelSlug: novel.slug },
    props: { novel },
  }));
}

const { novel } = Astro.props;
const novelStats = stats[novel.slug] || { chapters: 0, words: 0, wordsFormatted: '0' };

const novelInfo = {
  ...novel,
  chapters: novelStats.chapters,
  words: novelStats.wordsFormatted
};

// Get all chapters for this novel
const allChapters = await getCollection('novels');
const chapters = allChapters
  .filter(c => c.id.toLowerCase().startsWith(`${novel.slug.toLowerCase()}/`))
  .sort((a, b) => (a.data.order || 0) - (b.data.order || 0));

// Use parts from config, or default if not present
const parts = novel.parts || [
  { title: '全書目錄', range: [0, 9999] }
];

function getChapterSlug(id: string) {
  // Remove novel prefix (case-insensitive) and .md extension
  const regex = new RegExp(`^${novel.slug}\/`, 'i');
  return id.replace(regex, '').replace('.md', '');
}

// Pre-calculate chapters for each part to avoid logic in JSX
const partsWithChapters = parts.map((part) => {
  const partChapters = chapters.filter((c) => {
    return c.data.order >= part.range[0] && c.data.order <= part.range[1];
  });
  return { ...part, chapters: partChapters };
});
---

<BaseLayout title={`${novelInfo.title} - 目錄`}>
  <div class="container">
    <header class="novel-header">
      <div class="novel-cover">
        {novelInfo.coverUrl && <img src={novelInfo.coverUrl} alt={novelInfo.title} />}
      </div>
      <div class="novel-info">
        <h1>{novelInfo.title}</h1>
        {novelInfo.titleEn && <p class="title-en">{novelInfo.titleEn}</p>}
        <p class="meta">{config.site.author} · {novelInfo.statusText || novelInfo.status} · {chapters.length} 章</p>
        <p class="description">{novelInfo.description}</p>
      </div>
    </header>

    {novel.videoUrl && (
      <section class="novel-video">
        <video controls preload="metadata" poster={novelInfo.coverUrl}>
          <source src={novel.videoUrl} type="video/mp4" />
          您的瀏覽器不支援影片播放。
        </video>
      </section>
    )}

    <nav class="toc">
      {partsWithChapters.map((part) => {
        if (part.chapters.length === 0) return null;

        return (
          <section class="part">
            <h2>{part.title}</h2>
            <ul class="chapter-list">
              {part.chapters.map((chapter) => (
                <li>
                  <a href={`/novel/${novel.slug}/${getChapterSlug(chapter.id)}`}>
                    <span class="chapter-title">{chapter.data.title}</span>
                  </a>
                </li>
              ))}
            </ul>
          </section>
        );
      })}
    </nav>
  </div>
</BaseLayout>

<style>
  .novel-header {
    display: flex;
    gap: 2rem;
    padding: 3rem 0;
    border-bottom: 1px solid var(--color-border);
    margin-bottom: 2rem;
    align-items: flex-start;
  }

  .novel-cover {
    flex-shrink: 0;
  }

  .novel-cover img {
    width: 200px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  }

  .novel-info {
    flex: 1;
  }

  .novel-info h1 {
    font-size: 2rem;
    font-weight: 700;
    margin-bottom: 0.25rem;
    color: var(--color-primary);
  }

  .novel-info .title-en {
    font-size: 1.1rem;
    color: var(--color-accent);
    margin-bottom: 0.75rem;
    font-style: italic;
  }

  .novel-info .meta {
    color: var(--color-text-muted);
    margin-bottom: 1rem;
  }

  .novel-info .description {
    color: var(--color-text-secondary);
    line-height: 1.7;
  }

  @media (max-width: 640px) {
    .novel-header {
      flex-direction: column;
      align-items: center;
      text-align: center;
    }
    .novel-cover img {
      width: 150px;
    }
  }

  .novel-video {
    margin: 2rem 0;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  }

  .novel-video video {
    width: 100%;
    display: block;
  }

  .toc {
    margin-top: 2rem;
  }

  .part {
    margin-bottom: 3rem;
  }

  .part h2 {
    font-size: 1.25rem;
    color: var(--color-accent);
    border-bottom: 1px solid var(--color-border);
    padding-bottom: 0.5rem;
    margin-bottom: 1rem;
  }
</style>
