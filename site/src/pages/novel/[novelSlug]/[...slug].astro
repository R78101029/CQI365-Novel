---
import ChapterLayout from '../../../layouts/ChapterLayout.astro';
import { getCollection, render } from 'astro:content';
import config from '../../../../novels.config.json';

export async function getStaticPaths() {
  const allChapters = await getCollection('novels');
  
  // Flatten all chapters from all novels
  const paths = [];

  for (const novel of config.novels) {
    const chapters = allChapters
      .filter(c => c.id.toLowerCase().startsWith(`${novel.slug.toLowerCase()}/`))
      .sort((a, b) => (a.data.order || 0) - (b.data.order || 0));

    chapters.forEach((chapter, index) => {
      // Remove novel prefix (case-insensitive) and .md extension
      const regex = new RegExp(`^${novel.slug}\/`, 'i');
      const slug = chapter.id.replace(regex, '').replace('.md', '');
      
      const prevChapter = index > 0 ? chapters[index - 1] : null;
      const nextChapter = index < chapters.length - 1 ? chapters[index + 1] : null;

      paths.push({
        params: { 
          novelSlug: novel.slug,
          slug: slug 
        },
        props: {
          novel,
          chapter,
          prevChapter: prevChapter ? {
            slug: prevChapter.id.replace(regex, '').replace('.md', ''),
            title: prevChapter.data.title,
          } : null,
          nextChapter: nextChapter ? {
            slug: nextChapter.id.replace(regex, '').replace('.md', ''),
            title: nextChapter.data.title,
          } : null,
        },
      });
    });
  }

  return paths;
}

const { novel, chapter, prevChapter, nextChapter } = Astro.props;
const { Content } = await render(chapter);
---

<ChapterLayout
  title={chapter.data.title}
  novelTitle={`${novel.title} (${novel.titleEn})`}
  novelSlug={novel.slug}
  prevChapter={prevChapter}
  nextChapter={nextChapter}
  coverUrl={chapter.data.cover_url}
  cover={chapter.data.cover}
>
  <Content />
</ChapterLayout>
